name: web test lab CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  detect:
    runs-on: ubuntu-latest
    
    outputs:
      python: ${{ steps.list-changes.outputs.python_projects }}
      java: ${{ steps.list-changes.outputs.java_projects }}
      javascript: ${{ steps.list-changes.outputs.javascript_projects }}
      other: ${{ steps.list-changes.outputs.other_files }}
    
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: list changes
        id: list-changes
        run: | 
          chmod +x .github/scripts/*
          .github/scripts/list-changes.sh "${{ github.event_name }}" "${{ github.event.pull_request.base.sha }}" "${{ github.sha }}"
  
  python-tests:
    needs: detect
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.detect.outputs.python) }}
    
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version-file: "python/${{ matrix.project }}/.python-version"

      - name: install uv
        uses: astral-sh/setup-uv@v6

      - name: install dependencies
        working-directory: python/${{ matrix.project }}
        run: |
          uv sync

      - name: run tests
        working-directory: python/${{ matrix.project }}
        run: |
          chmod +x test.sh
          test.sh


